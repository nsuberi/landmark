define("main/config",[],function(){"use strict";var e={corsEnabledServers:["utility.arcgisonline.com"],defaultState:{x:-19,y:19,l:3},portalGenerateFeaturesURL:"http://www.arcgis.com/sharing/rest/content/features/generate",printUrl:"http://gis.wri.org/arcgis/rest/services/ExportWebMap/GPServer/Export%20Web%20Map",welcomeDialogContent:"<div style='font-size:14px;'><p class='launch-dialog-content'><span class='introTextTitle'>Landmark</span> is designed to help indigenous peoples and communities protect their lands. To achieve this goal, the platform must be current and comprehensive. Please help us by sharing your impressions and your information on collective lands (<a class='introTextTitle' href='contact.html'>Contact Us</a>).</p></div>"};return e}),define("utils/Helper",["dojo/on","dojo/topic","dojo/dom-class","dojo/dom-geometry","dojo/_base/window"],function(e,t,n,r,i){function l(){f=r.position(s).w,f<u?n.add(s,"mobile"):n.remove(s,"mobile"),a>o&&f<o&&$("#toolsMenuButton").hasClass("active")&&$("#layersMenuButton").click(),a<u&&f>u&&t.publish("changedLayout",!1),a>u&&f<u&&t.publish("changedLayout",!0),a=f}var s=i.body(),o=500,u=800,a,f,c={enableLayout:function(){brApp.debug("Helper >>> enableLayout"),l(),e(i.global,"resize",l)},isMobile:function(){return f?f<u:r.position(s).w<u}};return c}),define("utils/HashController",["dojo/hash","dojo/topic","dojo/_base/lang","dojo/io-query","dojo/_base/array","utils/HashController","main/config"],function(e,t,n,r,i,s,o){var u={},a={};return u.newState={},u.init=function(){var e=this,n,i=window.location.href,s=i.split("#").length==2&&i.split("#")[1].length>1;s?n=r.queryToObject(i.split("#")[1]):n=o.defaultState,t.subscribe("/dojo/hashchange",function(t){var n=r.queryToObject(t),i=a;e.handleHashChange(n,i)}),e.updateHash(n)},u.handleHashChange=function(e,t){var n=this;u.newState=e;var r=t.v!=e.v,i=e.v=="map",s=t.x!=e.x||t.y!=e.y||t.y!=e.y;i&&s&&EventsController.centerChange(e),a=e},u.updateHash=function(t){var i=this,s=n.clone(a);n.mixin(s,t);var o=r.objectToQuery(s);e(o)},u.getHash=function(){return r.queryToObject(e())},u}),define("map/MapConfig",["esri/InfoTemplate"],function(e){var t="http://gis.wri.org/arcgis/rest/services/LandMark/land_tenure/MapServer",n="http://gis.wri.org/arcgis/rest/services/LandMark/pct_comm_lands/MapServer",r="http://gis.wri.org/arcgis/rest/services/LandMark/comm_ind_FormalClaim/MapServer",i="http://gis.wri.org/arcgis/rest/services/LandMark/comm_ind_FormalDoc/MapServer",s="http://gis.wri.org/arcgis/rest/services/LandMark/comm_ind_InProcess/MapServer",o="http://gis.wri.org/arcgis/rest/services/LandMark/comm_ind_NoDoc/MapServer",u="http://gis.wri.org/arcgis/rest/services/LandMark/comm_ind_Occupied/MapServer",a="http://gis.wri.org/arcgis/rest/services/LandMark/comm_comm_FormalClaim/MapServer",f="http://gis.wri.org/arcgis/rest/services/LandMark/comm_comm_FormalDoc/MapServer",l="http://gis.wri.org/arcgis/rest/services/LandMark/comm_comm_InProcess/MapServer",c="http://gis.wri.org/arcgis/rest/services/LandMark/comm_comm_NoDoc/MapServer",h="http://gis.wri.org/arcgis/rest/services/LandMark/comm_comm_Occupied/MapServer",p={options:{sliderPosition:"top-right",basemap:"osm",centerX:-19,centerY:19,zoom:3},layers:{percentLands:{url:n,type:"dynamic",defaultLayers:[-1],visible:!0},analysisLayer:{url:"http://gis.wri.org/arcgis/rest/services/LandMark/comm_analysis/MapServer",type:"dynamic",defaultLayers:[0,1],visible:!1},indigenous_FormalClaim:{url:r,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},indigenous_FormalDoc:{url:i,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},indigenous_InProcess:{url:s,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},indigenous_NoDoc:{url:o,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},indigenous_Occupied:{url:u,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},indigenous_FormalClaim_Tiled:{url:r,type:"tiled",defaultLayers:[0,1],visible:!0},indigenous_FormalDoc_Tiled:{url:i,type:"tiled",defaultLayers:[0,1],visible:!0},indigenous_InProcess_Tiled:{url:s,type:"tiled",defaultLayers:[0,1],visible:!0},indigenous_NoDoc_Tiled:{url:o,type:"tiled",defaultLayers:[0,1],visible:!0},indigenous_Occupied_Tiled:{url:u,type:"tiled",defaultLayers:[0,1],visible:!0},community_FormalClaim:{url:a,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},community_FormalDoc:{url:f,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},community_InProcess:{url:l,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},community_NoDoc:{url:c,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},community_Occupied:{url:h,type:"dynamic",minZoom:2315e3,defaultLayers:[0,1],visible:!0},community_FormalClaim_Tiled:{url:a,type:"tiled",defaultLayers:[0,1],visible:!0},community_FormalDoc_Tiled:{url:f,type:"tiled",defaultLayers:[0,1],visible:!0},community_InProcess_Tiled:{url:l,type:"tiled",defaultLayers:[0,1],visible:!0},community_NoDoc_Tiled:{url:c,type:"tiled",defaultLayers:[0,1],visible:!0},community_Occupied_Tiled:{url:h,type:"tiled",defaultLayers:[0,1],visible:!0},landTenure:{url:t,type:"dynamic",defaultLayers:[-1],visible:!0},CustomFeatures:{type:"graphic",infoTemplate:{content:"<table><tr><td>Unique ID:</td><td>${WRI_ID:checkAvailable}</td></tr></table>"}}},geometryServiceURL:"http://utility.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer",communityLevelLayers:[{label:"Formally recognized",isCategory:!0,group:"indigenousLands"},{label:"Formal documentation",id:"indigenous_FormalDoc",checked:!0,group:"indigenousLands"},{label:"In process of documentation",id:"indigenous_InProcess",checked:!0,group:"indigenousLands"},{label:"No documentation",id:"indigenous_NoDoc",checked:!0,group:"indigenousLands"},{label:"Not formally recognized",isCategory:!0,group:"indigenousLands"},{label:"Formal land petition",id:"indigenous_FormalClaim",checked:!0,group:"indigenousLands"},{label:"Occupied or used without formal land claim",id:"indigenous_Occupied",checked:!0,group:"indigenousLands"},{label:"Formally recognized",isCategory:!0,group:"communityLands"},{label:"Formal documentation",id:"community_FormalDoc",checked:!0,group:"communityLands"},{label:"In process of documentation",id:"community_InProcess",checked:!0,group:"communityLands"},{label:"No documentation",id:"community_NoDoc",checked:!0,group:"communityLands"},{label:"Not formally recognized",isCategory:!0,group:"communityLands"},{label:"Formal land petition",id:"community_FormalClaim",checked:!0,group:"communityLands"},{label:"Occupied or used without formal land claim",id:"community_Occupied",checked:!0,group:"communityLands"}],landTenureCommunityLayers:[{label:"AVERAGE SCORE",id:"averageScoreTenure",question:"The average score for the 10 indicators of the legal security of community lands.",layer:0},{label:"1.	LEGAL STATUS ",id:"legalStatusTenure",question:"Does the law recognize all rights that communities exercise over their lands as lawful forms of ownership?",layer:1},{label:"2.	LAND RIGHTS AND COMMON PROPERTY ",id:"landRightsTenure",question:"Does the law give community land rights the same level of protection as the rights under other tenure systems?",layer:1},{label:"3.	FORMAL DOCUMENTATION ",id:"formalDocTenure",question:"Does the law require the government to provide communities with a formal title and map to their land?",layer:1},{label:"4.	LEGAL PERSON",id:"legalPersonTenure",question:"Does the law recognize the community as a legal person for the purposes of land ownership?",layer:1},{label:"5.	LEGAL AUTHORITY",id:"legalAuthorityTenure",question:"Does the law recognize the community as the legal authority over the land?",layer:1},{label:"6.	PERPETUITY",id:"perpetuityTenure",question:"Do the law and formal title recognize that community land rights may be held in perpetuity?",layer:1},{label:"7.	RIGHT TO CONSENT BEFORE LAND ACQUISITION",id:"rightToConsentTenure",question:"Does the law require the consent of communities before government or an outsider may acquire their land?",layer:1},{label:"8.	RIGHTS TO TREES ",id:"rightToTreesTenure",question:"Does the law explicitly recognize that community land includes the rights to all trees on the land?",layer:1},{label:"9.	RIGHTS TO WATER ",id:"rightToWaterTenure",question:"Does the law explicitly recognize that community land includes the rights to local water sources on the land?",layer:1},{label:"10.	LAND RIGHTS IN PROTECTED AREAS",id:"landRightsProtectedAreasTenure",question:"Does the law uphold community land rights in the ownership and governance of national parks and other protected areas?",layer:1}],landTenureIndigenousLayers:[{label:"AVERAGE SCORE",id:"averageScoreTenure",question:"The average score for the 10 indicators of the legal security of indigenous lands.",layer:2},{label:"1.	LEGAL STATUS ",id:"legalStatusTenure",question:"Does the law recognize all rights that Indigenous peoples exercise over their lands as lawful forms of ownership?",layer:3},{label:"2.	LAND RIGHTS AND COMMON PROPERTY ",id:"landRightsTenure",question:"Does the law give indigenous land rights the same level of protection as the rights under other tenure systems?",layer:3},{label:"3.	FORMAL DOCUMENTATION ",id:"formalDocTenure",question:"Does the law require the government to provide Indigenous peoples with a formal title and map to their land?",layer:3},{label:"4.	LEGAL PERSON",id:"legalPersonTenure",question:"Does the law recognize Indigenous peoples as a legal person for the purposes of land ownership?",layer:3},{label:"5.	LEGAL AUTHORITY",id:"legalAuthorityTenure",question:"Does the law recognize Indigenous peoples as the legal authority over the land?",layer:3},{label:"6.	PERPETUITY",id:"perpetuityTenure",question:"Do the law and formal title recognize that indigenous land rights may be held in perpetuity?",layer:3},{label:"7.	RIGHT TO CONSENT BEFORE LAND ACQUISITION",id:"rightToConsentTenure",question:"Does the law require the consent of Indigenous peoples before government or an outsider may acquire their land?",layer:3},{label:"8.	RIGHTS TO TREES ",id:"rightToTreesTenure",question:"Does the law explicitly recognize that indigenous land includes the rights to all trees on the land?",layer:3},{label:"9.	RIGHTS TO WATER ",id:"rightToWaterTenure",question:"Does the law explicitly recognize that indigenous land includes the rights to local water sources on the land?",layer:3},{label:"10.	LAND RIGHTS IN PROTECTED AREAS",id:"landRightsProtectedAreasTenure",question:"Does the law uphold indigenous land rights in the ownership and governance of national parks and other protected areas?",layer:3}],percentIndigenousLayersCombined:[{label:"Indigenous and Community Lands (combined)",id:"percentIndigAndCommunity",subTitle:!0},{label:"Total",id:"combinedTotal",question:!1,layer:1,subLayer:!0},{label:"Formally recognized",id:"combinedFormal",question:!1,layer:2,subLayer:!0},{label:"Not formally recognized",id:"combinedInformal",question:!1,layer:3,subLayer:!0},{label:"Indigenous Lands (only)",id:"percentIndigNational",subTitle:!0},{label:"Total",id:"indigTotal",question:!1,layer:5,subLayer:!0},{label:"Formally recognized",id:"indigFormal",question:!1,layer:6,subLayer:!0},{label:"Not formally recognized",id:"indigInformal",question:!1,layer:7,subLayer:!0},{label:"Community Lands (only)",id:"percentNonIndigenous",subTitle:!0},{label:"Total",id:"commTotal",question:!1,layer:9,subLayer:!0},{label:"Formally recognized",id:"commFormal",question:!1,layer:10,subLayer:!0},{label:"Not formally recognized",id:"commInformal",question:!1,layer:11,subLayer:!0}],layerMapping:{indigenousLands:[],indigenousOfficial:[],indigenousUnofficial:[],indigenousFormalTitle:[1,6],indigenousInProcess:[2,7],indigenousLandClaim:[3,8],indigenousNoLandClaim:[4,9],communityLands:[],communityOfficial:[],communityUnofficial:[],communityFormalTitle:[11],communityInProcess:[12],communityLandClaim:[13],communityNoLandClaim:[14]}};return p}),define("map/Map",["dojo/Evented","dojo/_base/declare","dojo/number","map/MapConfig","dojo/on","dijit/registry","utils/HashController","esri/map","esri/geometry/webMercatorUtils","esri/layers/ImageParameters","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/GraphicsLayer"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){"use strict";var p=t([e],{element:"brMap",constructor:function(e,n){t.safeMixin(this,e),n&&(this.element=n),this.createMap()},createMap:function(){var e=this,t=o.getHash(),r=e.centerX,i=e.centerY,s=e.zoom;e.map=new u(this.element,{basemap:this.basemap,center:[t.x,t.y],sliderPosition:this.sliderPosition,zoom:t.l}),e.map.on("load",function(){e.emit("map-ready",{}),e.map.graphics.clear(),e.map.resize(),e.addLayers()}),e.map.on("extent-change",function(e){var t=e.delta,r=a.webMercatorToGeographic(e.extent),i=e.levelChange,s=e.lod,u=e.target,f=n.round(r.getCenter().x,2),l=n.round(r.getCenter().y,2);o.updateHash({x:f,y:l,l:s.level})})},addLayers:function(){var e=r.layers,t=this,n,o=[],u;for(u in e)switch(e[u].type){case"dynamic":e[u].minZoom?o.push(t.addDynamicLayer(u,e[u],e[u].minZoom)):o.push(t.addDynamicLayer(u,e[u]));break;case"graphic":o.push(t.addGraphicLayer(u,e[u]));break;case"tiled":o.push(t.addTiledLayer(u,e[u],e[u]));break;default:}i.once(this.map,"layers-add-result",function(e){t.emit("layers-loaded",e);var n=e.layers.map(function(e){return{layer:e.layer}});s.byId("legend").refresh(n)}),this.map.addLayers(o),addthis.init()},addDynamicLayer:function(e,t,n){var r=new f,i;return r.layerOption=f.LAYER_OPTION_SHOW,r.layerIds=t.defaultLayers,r.format="png32",n?i=new l(t.url,{visible:t.visible||!1,imageParameters:r,id:e,minScale:n}):i=new l(t.url,{visible:t.visible||!1,imageParameters:r,id:e}),i.on("error",this.addLayerError.bind(this)),i},addTiledLayer:function(e,t){var n=new c(t.url,{displayLevels:[0,1,2,3,4,5,6,7],id:e});return n.on("error",this.addLayerError.bind(this)),n},addGraphicLayer:function(e,t){var n=new h({id:e});return n.on("error",this.addLayerError.bind(this)),n},addLayerError:function(e){this.emit("layer-error",e.target.id)}});return p}),define("map/MapAssets",["esri/Color","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/renderers/UniqueValueRenderer"],function(e,t,n,r){"use strict";var i={getDrawUploadSymbol:function(){return new t(t.STYLE_SOLID,new n(n.STYLE_SOLID,new e([0,0,0]),2),new e([255,255,255,.5]))},getUniqueValueRendererForNationalDataWithField:function(e,t){var n,i,s,o,u,a,f;return a=brApp.landTenureRenderer.uniqueValueInfos[5].symbol,f=new r(a,e),f.addValue({value:brApp.landTenureRenderer.uniqueValueInfos[0].value,symbol:brApp.landTenureRenderer.uniqueValueInfos[0].symbol,label:brApp.landTenureRenderer.uniqueValueInfos[0].label}),f.addValue({value:brApp.landTenureRenderer.uniqueValueInfos[1].value,symbol:brApp.landTenureRenderer.uniqueValueInfos[1].symbol,label:brApp.landTenureRenderer.uniqueValueInfos[1].label}),f.addValue({value:brApp.landTenureRenderer.uniqueValueInfos[2].value,symbol:brApp.landTenureRenderer.uniqueValueInfos[2].symbol,label:brApp.landTenureRenderer.uniqueValueInfos[2].label}),f.addValue({value:brApp.landTenureRenderer.uniqueValueInfos[3].value,symbol:brApp.landTenureRenderer.uniqueValueInfos[3].symbol,label:brApp.landTenureRenderer.uniqueValueInfos[3].label}),f.addValue({value:brApp.landTenureRenderer.uniqueValueInfos[4].value,symbol:brApp.landTenureRenderer.uniqueValueInfos[4].symbol,label:brApp.landTenureRenderer.uniqueValueInfos[4].label}),f.addValue({value:brApp.landTenureRenderer.uniqueValueInfos[5].value,symbol:brApp.landTenureRenderer.uniqueValueInfos[5].symbol,label:brApp.landTenureRenderer.uniqueValueInfos[5].label}),f.attributeField=e,f},getNationalLevelIndicatorCode:function(){var e;console.log(brApp.currentLayer);switch(brApp.currentLayer){case"averageScoreTenure":e="Avg_Scr";break;case"legalStatusTenure":e="1";break;case"landRightsTenure":e="2";break;case"formalDocTenure":e="3";break;case"legalPersonTenure":e="4";break;case"legalAuthorityTenure":e="5";break;case"perpetuityTenure":e="6";break;case"rightToConsentTenure":e="7";break;case"rightToTreesTenure":e="8";break;case"rightToWaterTenure":e="9";break;case"landRightsProtectedAreasTenure":e="10"}return e}};return i}),define("map/Uploader",["main/config","map/MapAssets","dojo/sniff","esri/graphic","esri/request","dijit/registry","dojo/_base/array","dojo/store/Memory","dojo/dom-construct","dijit/form/ComboBox","esri/geometry/Polygon","esri/geometry/scaleUtils"],function(e,t,n,r,i,s,o,u,a,f,l,c){"use strict";var h={beginUpload:function(t){var r=t.target?t.target:t.srcElement;if(r.value==="")return;var s=r.value.toLowerCase(),o=this,u,a,f;if(n("ie")){var l=s.split("\\");s=l[l.length-1]}if(s.indexOf(".zip")<0){alert('Currently only shapefiles with a ".zip" extension are supported.');return}s=s.split("."),s=s[0].replace("c:\\fakepath\\",""),a={name:s,generalize:!0,targetSR:brApp.map.spatialReference,maxRecordCount:1e3,reducePrecision:!0,numberOfDigitsAfterDecimal:0,enforceInputFileSizeLimit:!0,enforceOutputJsonSizeLimit:!0},f=c.getExtentForScale(brApp.map,4e4),a.maxAllowableOffset=f.getWidth()/brApp.map.width,u={publishParameters:JSON.stringify(a),"callback.html":"textarea",filetype:"shapefile",f:"json"},i({url:e.portalGenerateFeaturesURL,content:u,form:document.getElementById("uploadForm"),handleAs:"json",error:this.uploadError,load:this.uploadSuccess.bind(this)})},uploadError:function(e){alert(["Error:",e.message].join(" "))},uploadSuccess:function(e){function c(){s.byId("uploadComboNameWidget")&&s.byId("uploadComboNameWidget").destroy(),document.getElementById("dropdownContainerName")&&a.destroy("dropdownContainerName"),document.uploadForm.reset()}var t=document.getElementById("uploadNameSelectContainer"),n=e.featureCollection,r=[],i=this,l;o.forEach(n.layers[0].layerDefinition.fields,function(e){r.push({name:e.name,id:e.alias})}),a.create("div",{id:"dropdownContainerName",innerHTML:"<div id='uploadComboNameWidget'></div>"},t,"first"),l=new u({data:r}),new f({id:"uploadComboNameWidget",value:"-- Choose name field --",store:l,searchAttr:"name",onChange:function(e){e&&(i.addToMap(e,n.layers[0].featureSet),s.byId("analysis-dialog").hide(),c())}},"uploadComboNameWidget")},addToMap:function(e,n){var i=t.getDrawUploadSymbol(),s=brApp.map.getLayer("CustomFeatures"),u,a,f;o.forEach(n.features,function(e){a=new l(e.geometry);var t=s.graphics.length+1;e.attributes.attributeID=t,u=new r(a,i,e.attributes),f=f?f.union(a.getExtent()):a.getExtent(),s.add(u)}),brApp.map.setExtent(f,!0)}};return h}),define("map/WidgetsController",["main/config","dojo/on","dojo/dom","dijit/Dialog","dojo/_base/fx","dojo/dom-class","dojo/cookie","dojo/dom-style","dijit/registry","esri/tasks/PrintTask","esri/tasks/PrintTemplate","esri/tasks/PrintParameters"],function(e,t,n,r,i,s,o,u,a,f,l,c){"use strict";var h=300,p={toggleLegend:function(){brApp.debug("WidgetsController >>> toggleLegend");var e=document.getElementById("legend-content"),t=document.querySelector(".brMap .legend-content"),n=document.getElementById("legend-container"),r=document.getElementById("legend-toggle-icon"),o=s.contains(t,"active"),u=o?170:210,a=o?200:260,f=o?0:e.scrollHeight;o?$("#legend-toggle-icon").html("+"):$("#legend-toggle-icon").html("&ndash;"),s.toggle(t,"active"),i.animateProperty({node:e,properties:{height:f},duration:h,onEnd:function(){f!==0&&(e.style.height="auto")}}).play(),i.animateProperty({node:n,properties:{width:a},duration:h}).play(),i.animateProperty({node:r,properties:{left:u},duration:300}).play()},toggleBasemapGallery:function(){brApp.debug("WidgetsController >>> toggleBasemapGallery");var e=document.querySelector(".brMap .basemap-container"),t=document.querySelector(".brMap .basemap-connector");this.shareContainerVisible()&&this.toggleShareContainer(),e&&t&&(s.toggle(e,"hidden"),s.toggle(t,"hidden"))},toggleShareContainer:function(){brApp.debug("WidgetsController >>> toggleShareContainer");var e=document.querySelector(".brMap .share-container"),t=document.querySelector(".brMap .share-connector");this.basemapContainerVisible()&&this.toggleBasemapGallery(),e&&t&&(s.toggle(e,"hidden"),s.toggle(t,"hidden"))},shareContainerVisible:function(){return!s.contains(document.querySelector(".brMap .share-container"),"hidden")},basemapContainerVisible:function(){return!s.contains(document.querySelector(".brMap .basemap-container"),"hidden")},toggleTreeContainer:function(){brApp.debug("WidgetsController >>> toggleTreeContainer");var e=document.getElementById("tree-widget-container"),t=document.getElementById("tree-container-toggle"),n=document.getElementById("tree-title"),r=document.getElementById("layer-content"),o=document.querySelector(".layer-tab-container"),u=s.contains(r,"active"),a,f;t.innerHTML=u?"&plus;":"&minus;",s.toggle(t,"padding-right"),s.toggle(o,"hidden"),console.log(u),a=u?0:e.offsetHeight-34,f=u?250:360,console.log(f),i.animateProperty({node:r,properties:{height:a},duration:h,onEnd:function(){s.toggle(r,"active")}}).play(),i.animateProperty({node:r,properties:{width:f},duration:h}).play(),i.animateProperty({node:o,properties:{height:a},duration:h}).play(),i.animateProperty({node:n,properties:{width:f},duration:h}).play()},toggleMobileMenu:function(){brApp.debug("WidgetsController >>> toggleMobileMenu");var e=document.getElementById("brMap"),t="mobileMenu",n="mobile-menu-toggle",r=s.contains(t,"open"),o=r?0:290;$("#layer-content").css("height")==="0px"&&$("#layer-content").css("height","auto"),$("#community-level-toggle_button").hide(),r?($("#mobile-menu-toggle").css("display","block"),s.remove(n,"hidden")):($("#mobile-menu-toggle").css("display","none"),s.toggle(t,"open"),s.toggle(n,"hidden")),i.animateProperty({node:e,properties:{left:o},duration:h,onEnd:function(){brApp.map.resize(),r&&s.toggle(t,"open"),$("#community-level-toggle_button").show()}}).play()},mobileMenuIsOpen:function(){return s.contains("mobileMenu","open")},toggleMobileMenuContainer:function(e){brApp.debug("WidgetsController >>> toggleMobileMenuContainer");var t=e.target?e.target:e.srcElement,n=document.querySelector(".segmented-menu-button.active"),r=document.querySelector(".mobile-menu-content.active"),i;if(s.contains(t,"active"))return;n&&s.remove(n,"active"),r&&s.remove(r,"active");switch(t.id){case"legendMenuButton":i="mobile-legend-content";break;case"toolsMenuButton":i="mobile-tools-content";break;case"layersMenuButton":i="mobile-layers-content"}s.add(t,"active"),s.add(i,"active")},showEmbedCode:function(){a.byId("embedCodeShareDialog")&&a.byId("embedCodeShareDialog").destroy();var e="<iframe src='"+window.location+"' height='600' width='900'></iframe>",t=new r({title:"Embed Code",style:"width: 350px",id:"embedCodeShareDialog",content:'Copy the code below to embed in your site. (Ctrl+C on PC and Cmd+C on Mac)<div class=\'dijitDialogPaneActionBar\'><input id="embedInput" type="text" value="'+e+'" autofocus /></div>'}),i;i=function(){},t.show(),n.byId("embedInput").select(),t.on("cancel",function(){i()})},showWelcomeDialog:function(){brApp.debug("WidgetsController >>> showWelcomeDialog");var t=e.welcomeDialogContent,i="launch-dialog",s,u,f,l;f=function(e){u(),l.hide()},u=function(){n.byId("welcomeDialogMemory")&&n.byId("welcomeDialogMemory").checked&&o("launch-dialog","dontShow",{expires:7})},a.byId(i)?l=a.byId(i):(t+="<input type='checkbox' id='welcomeDialogMemory'> Don't show this dialog again",l=new r({id:i,content:t,style:"width: 450px;max-width: 760px;"})),s=o("launch-dialog"),s===undefined||s!=="dontShow"?(l.show(),l.on("cancel",function(){f(!1)})):f(!0)},toggleUploadForm:function(){brApp.debug("WidgetsController >>> toggleUploadForm"),s.toggle("upload-form-content","hidden")},printMap:function(){brApp.debug("WidgetsController >>> printMap");var t=new f(e.printUrl),n=new c,r=new l;r.format="pdf",r.layout="landmark",r.preserveScale=!1,r.layoutOptions={customTextElements:[]},n.map=brApp.map,n.template=r,s.add("print-widget","loading"),t.execute(n,function(e){s.remove("print-widget","loading"),window.open(e.url)},function(e){console.log(e),s.remove("print-widget","loading")})},showAnalysisDialog:function(e){brApp.debug("WidgetsController >>> showAnalysisDialog"),e.graphics.length>0?($("#remove-graphics").removeClass("hidden"),$("#draw-shape").addClass("display-three"),$("#upload-shapefile").addClass("display-three")):($("#remove-graphics").addClass("hidden"),$("#draw-shape").removeClass("display-three"),$("#upload-shapefile").removeClass("display-three")),a.byId("analysis-dialog").show()},showHelp:function(e){brApp.debug("WidgetsController >>> showHelp"),e.stopPropagation();var t=e.target.id,n,r=e.pageX+"px",i=e.pageY+"px";switch(t){case"indigenous-lands-help":n=a.byId("help-dialog-indigenous"),n.show(),$("#help-dialog-indigenous").css("top",i),$("#help-dialog-indigenous").css("left",r);break;case"community-lands-help":n=a.byId("help-dialog-community"),n.show(),$("#help-dialog-community").css("top",i),$("#help-dialog-community").css("left",r);break;case"analysis-help":var r=e.pageX-300+"px";n=a.byId("help-dialog-completeness"),n.show(),$("#help-dialog-completeness").css("top",i),$("#help-dialog-completeness").css("left",r)}}};return p}),define("map/DrawTool",["map/MapAssets","map/WidgetsController","map/MapConfig","esri/graphic","dijit/registry","esri/toolbars/draw","esri/geometry/Polygon"],function(e,t,n,r,i,s,o){"use strict";var u,a,f={init:function(){u=!1,a=new s(brApp.map),a.on("draw-end",this.complete.bind(this))},complete:function(t){this.deactivate();if(!t.geometry)return;var n=e.getDrawUploadSymbol(),i=brApp.map.getLayer("CustomFeatures"),s={},u,a,f=i.graphics.length+1;s.attributeID=f,a=new o(t.geometry),u=new r(a,n,s),i.add(u),console.log(u),$("#remove-graphics").removeClass("hidden")},activate:function(){a.activate(s.FREEHAND_POLYGON),u=!0,i.byId("analysis-dialog").hide(),t.mobileMenuIsOpen()&&t.toggleMobileMenu()},deactivate:function(){a.deactivate(),u=!1},isActive:function(){return u}};return f}),define("map/LayerController",["dojo/topic","dojo/on","dijit/registry","map/MapConfig","map/MapAssets","dojo/_base/array","esri/layers/LayerDrawingOptions"],function(e,t,n,r,i,s,o){"use strict";var u={updateVisibleLayers:function(t,i,s){brApp.debug("LayerController >>> updateVisibleLayers");var o=[],u,a,f,l=this;if(i)o=t,console.log(o),o.indexOf(-1)!==0&&l.turnOffCommunityLevelData(),brApp.currentLayer==="percentIndigenousLayers"?(a=brApp.map.getLayer("landTenure"),a.setVisibleLayers([-1]),u=brApp.map.getLayer("percentLands"),u.setVisibleLayers(o),console.log(o)):(a=brApp.map.getLayer("percentLands"),a.setVisibleLayers([-1]),u=brApp.map.getLayer("landTenure"),this.setLandTenureRenderer(o),u.setVisibleLayers(o,!0),console.log(o)),e.publish("refresh-legend");else{for(var c=0;c<t.length;c++){f=brApp.map.getLayer(t[c]);var h=brApp.map.getLayer(t[c]+"_Tiled"),p=document.getElementById("legend_"+h.id),d=brApp.map.getZoom(),v=n.byId("legend");s===!0?(f.hide(),h.hide()):(l.turnOffNationalLevelData(),f.show(),h.show()),requestAnimationFrame(function(){for(var e in r.layers)if(r.layers[e].type==="tiled"){var t=document.getElementById("legend_"+e);brApp.map.getZoom()>7&&t&&t.classList.add("hideLegend")}})}e.publish("refresh-legend")}},turnOffCommunityLevelData:function(){var e=$("#indigenousLands")[0].firstChild,t=$("#communityLands")[0].firstChild;if(e.classList.contains("parent-layer-checked-true")&&t.classList.contains("parent-layer-checked-true"))e.click(),t.click();else if(e.classList.contains("parent-layer-checked-true"))e.click();else if(t.classList.contains("parent-layer-checked-true"))t.click();else{var n=document.querySelectorAll(".layer-node");for(var r=0;r<n.length;r++)n[r].getAttribute("data-clicked")=="true"&&n[r].firstChild.click()}$("#toolsMenuButton").addClass("minimizedHide"),$("#legendMenuButton").addClass("minimizedAdjust"),$("#analysis-button").addClass("grayOut"),$("#analysisLogo").addClass("grayOutButton"),$("#analysis-help").addClass("grayOutIcon"),$("#analysis-button").mouseenter(function(){$("#analysis-button-tt").show()}),$("#analysis-button").mouseleave(function(){$("#analysis-button-tt").hide()})},turnOffNationalLevelData:function(){$("#toolsMenuButton").removeClass("minimizedHide"),$("#legendMenuButton").removeClass("minimizedAdjust"),$("#analysis-button").removeClass("grayOut"),$("#analysisLogo").removeClass("grayOutButton"),$("#analysis-help").removeClass("grayOutIcon"),$("#analysis-button").unbind("mouseenter mouseleave"),$("#nationalLevelNone").click()},setLandTenureRenderer:function(t){var n=[],r,u,a,f,l;u=i.getNationalLevelIndicatorCode(),f=["I",u,"_Scr"].join("");if(u==="Avg_Scr"){a=brApp.map.getLayer("landTenure"),a.setVisibleLayers(t,!0),e.publish("refresh-legend"),brApp.map.setExtent(brApp.map.extent);return}console.log(f),r=new o,a=brApp.map.getLayer("landTenure"),l=i.getUniqueValueRendererForNationalDataWithField(f,a),r.renderer=l,s.forEach(t,function(e){n[e]=r}),a.setLayerDrawingOptions(n),e.publish("refresh-legend"),brApp.map.setExtent(brApp.map.extent)}};return u}),define("components/NationalLayerList",["react","map/MapConfig","map/LayerController"],function(e,t,n){"use strict";var r="land-tenure-indigenous",i="land-tenure-community",s="land-tenure",o="percent-indigenous",u=e.createClass({displayName:"LayerList",getInitialState:function(){return this.props.class==="percent-indigenous-tree"?{active:this.props.data[1].id}:{active:this.props.data[0].id}},render:function(){return e.createElement("div",{className:this.props.class||"national-level-layer-list"},this.props.data.map(this.dataMapper,this))},dataMapper:function(t,n){var r=this.state.active===t.id,i=t.subTitle,s=t.subLayer,o=t.layer;return e.createElement("div",{className:"national-layer-list-item "+(r?"active":"")+(i?"subTitle":"")+(s?"subLayer":""),key:t.id,onClick:o!=undefined?this.setActiveLayer.bind(this,t.id,t.layer):null},e.createElement("div",{className:"national-layer-list-item-label"},t.label),t.question?e.createElement("div",{className:"national-layer-list-item-question"},t.question):null)},setActiveLayer:function(e,t){this.setState({active:e}),this.props.change(e,t)}}),a=e.createClass({displayName:"NationalLayerList",getInitialState:function(){return{active:"none",landTenureCategory:r,landTenureLayer:2,activePercentIndigenousLayer:1,activeCommunityKey:t.landTenureCommunityLayers[0].id,activeIndigenousKey:t.landTenureIndigenousLayers[0].id}},componentDidMount:function(){brApp.currentLayer=this.state.landTenureCategory===r?this.state.activeIndigenousKey:this.state.activeCommunityKey},setToNone:function(){this.state.active!=="none"&&this.setState({active:"none"})},componentDidUpdate:function(){var e,t=this.state;console.log(t.active);switch(t.active){case"none":e=[-1];break;case s:this.state.landTenureCategory===r?(console.log("activeIndigenousKey",this.state.activeIndigenousKey),this.state.activeIndigenousKey==="averageScoreTenure"?e=[2]:e=[3]):(console.log("activeCommunityKey",this.state.activeCommunityKey),this.state.activeCommunityKey==="averageScoreTenure"?e=[0]:e=[1]),brApp.currentLayer=t.landTenureCategory===r?t.activeIndigenousKey:t.activeCommunityKey;break;case o:e=[t.activePercentIndigenousLayer],brApp.currentLayer="percentIndigenousLayers"}console.log(e),n.updateVisibleLayers(e,!0)},changeLandTenureCategory:function(e){this.setState({landTenureCategory:e.target.id})},changePercentIndigenousLayer:function(e,t){if(!t)return;this.setState({activePercentIndigenousLayer:t})},changeLandTenureLayer:function(e,t){t===0||t===1?this.setState({activeCommunityKey:e}):this.setState({activeIndigenousKey:e})},handleRadioChange:function(e){var t=e.target.getAttribute("value");this.setState({active:t})},render:function(){return e.createElement("div",{className:"national-level-layer-lists"},e.createElement("div",{className:"radio-button-container"},e.createElement("label",null,e.createElement("span",{id:"nationalLevelPercent",name:"national-layer-selection",type:"radio",value:o,className:this.state.active===o?"checked":"unchecked",checked:this.state.active===o,onClick:this.handleRadioChange}),e.createElement("span",{className:"national-layer-selection-label"},"Percent of Indigenous and Community Lands"))),e.createElement("div",{className:"percent-indigenous-layer-list",style:{display:this.state.active===o?"block":"none"}},e.createElement(u,{"class":"percent-indigenous-tree",data:t.percentIndigenousLayersCombined,change:this.changePercentIndigenousLayer})),e.createElement("div",{className:"radio-button-container"},e.createElement("label",null,e.createElement("span",{id:"nationalLevelIndicators",name:"national-layer-selection",type:"radio",value:s,className:this.state.active===s?"checked":"unchecked",checked:this.state.active===s,onClick:this.handleRadioChange}),e.createElement("span",{className:"national-layer-selection-label"},"Indicators of the Legal Security of Indigenous and Community Lands"))),e.createElement("div",{className:"land-tenure-layer-list",style:{display:this.state.active===s?"block":"none"}},e.createElement("div",{className:"land-tenure-menu-explanation"},"Choose Indicators for Indigenous or Community land:"),e.createElement("div",{className:"land-tenure-menu-controls"},e.createElement("span",{id:r,onClick:this.changeLandTenureCategory,className:"land-tenure-menu-button "+(this.state.landTenureCategory===r?"active":"")},"Indigenous"),e.createElement("span",{id:i,onClick:this.changeLandTenureCategory,className:"land-tenure-menu-button "+(this.state.landTenureCategory===i?"active":"")},"Community")),e.createElement("div",{className:this.state.landTenureCategory===r?"":"hidden"},e.createElement(u,{data:t.landTenureIndigenousLayers,change:this.changeLandTenureLayer})),e.createElement("div",{className:this.state.landTenureCategory===i?"":"hidden"},e.createElement(u,{data:t.landTenureCommunityLayers,change:this.changeLandTenureLayer}))),e.createElement("div",{className:"radio-button-container"},e.createElement("label",null,e.createElement("span",{id:"nationalLevelNone",name:"national-layer-selection",type:"radio",defaultChecked:!0,value:"none",className:this.state.active==="none"?"checked":"unchecked",checked:this.state.active==="none",onClick:this.handleRadioChange}),e.createElement("span",{className:"national-layer-selection-label"},"None"))))}});return a}),define("components/CommunityLayerList",["react","map/LayerController","map/WidgetsController"],function(e,t,n){"use strict";var r=e.createClass({displayName:"CommunityLayerList",getInitialState:function(){return{data:this.props.data}},toggleOff:function(e,n){t.updateVisibleLayers(e,!1,n)},render:function(){return e.createElement("div",{className:"community-layer-list"},e.createElement("div",{className:"community-layer-type"},e.createElement("div",{className:"community-layer-type-label",id:"indigenousLands"},e.createElement("span",{className:"parent-layer-checked-true",onClick:this.parentClicked}),"Indigenous Lands",e.createElement("span",{id:"indigenous-lands-help",className:"parent-layer-help",onClick:this.showHelp})),this.state.data.map(this.layerMapper("indigenousLands"),this)),e.createElement("div",{className:"community-layer-type"},e.createElement("div",{className:"community-layer-type-label",id:"communityLands"},e.createElement("span",{className:"parent-layer-checked-true",onClick:this.parentClicked}),"Community Lands",e.createElement("span",{id:"community-lands-help",className:"parent-layer-help",onClick:this.showHelp})),this.state.data.map(this.layerMapper("communityLands"),this)))},layerMapper:function(t){var n=this;return function(r){return r.group!==t?null:r.isCategory?e.createElement("div",{className:"layer-category"},r.label):e.createElement("div",{className:"layer-node",onClick:n.layerClicked,"data-id":r.id,"data-clicked":r.checked},e.createElement("span",{className:"layer-checked-"+r.checked}),r.label)}},layerClicked:function(e){e.stopPropagation();if(e.target.classList.length===0||e.target.parentElement.getAttribute("data-id")===null)return;var t=e.target.parentElement.getAttribute("data-id"),n=e.target.parentElement.getAttribute("data-clicked");n==="true"?(e.target.classList.remove("layer-checked-true"),e.target.classList.add("layer-checked-false"),e.target.parentElement.setAttribute("data-clicked",!1)):(e.target.classList.add("layer-checked-true"),e.target.classList.remove("layer-checked-false"),e.target.parentElement.setAttribute("data-clicked",!0));var r=n!=="true";for(var i=0;i<this.state.data.length;i++)this.state.data[i].group===t&&(this.state.data[i].checked=r);this.toggleOff([t],!r)},showHelp:function(e){console.log("ss"),n.showHelp(e)},parentClicked:function(e){e.stopPropagation();var t,n=[];e.target.classList.contains("parent-layer-checked-true")?(e.target.classList.remove("parent-layer-checked-true"),e.target.classList.add("parent-layer-checked-false"),t=!0):(e.target.classList.add("parent-layer-checked-true"),e.target.classList.remove("parent-layer-checked-false"),t=!1);for(var r=0;r<this.state.data.length;r++)if(this.state.data[r].group===e.target.parentElement.id&&this.state.data[r].isCategory!==!0){this.state.data[r].checked=t;var i=document.querySelectorAll("[data-id='"+this.state.data[r].id+"']")[0];n.push(this.state.data[r].id),t?(i.firstChild.classList.remove("layer-checked-true"),i.firstChild.classList.add("layer-checked-false"),i.setAttribute("data-clicked",!1)):(i.firstChild.classList.remove("layer-checked-false"),i.firstChild.classList.add("layer-checked-true"),i.setAttribute("data-clicked",!0))}this.toggleOff(n,t)}});return r}),define("components/LayerTabContainer",["react","map/MapConfig","components/NationalLayerList","components/CommunityLayerList"],function(e,t,n,r){"use strict";var i=e.createClass({displayName:"TabContainer",getInitialState:function(){return{activeTab:"community"}},toggleTab:function(){this.setState({activeTab:this.state.activeTab==="community"?"national":"community"})},render:function(){return e.createElement("div",{className:"layer-tab-container"},e.createElement("div",{className:"layer-tab-controls"},e.createElement("div",{onClick:this.toggleTab,className:"community-tab"+(this.state.activeTab==="community"?" active":"")},"Community Level"),e.createElement("div",{onClick:this.toggleTab,className:"community-tab"+(this.state.activeTab==="national"?" active":"")},"National Level")),e.createElement("div",{className:"layer-tab-content"},e.createElement("div",{className:"community-layers-tab tab-panel"+(this.state.activeTab==="community"?"":" hidden")},e.createElement(r,{data:t.communityLevelLayers})),e.createElement("div",{className:"national-layers-tab tab-panel"+(this.state.activeTab==="national"?"":" hidden")},e.createElement(n,null))))}});return function(t){return e.render(e.createElement(i,null),document.getElementById(t))}}),define("components/LegendComponent",["react","dojo/topic","map/MapConfig"],function(e,t,n){"use strict";var r="land-tenure-indigenous",i=e.createClass({displayName:"LayerGroup",getInitialState:function(){var e=this.dataGrabber();return e.forEach(function(e){e.layer.indexOf("indigenous")>-1?e.fakeLayer="indigenous":e.layer.indexOf("community")>-1&&(e.fakeLayer="community")}),this.objSort(e,["fakeLayer",!0],"group"),{layerInfos:brApp.layerInfos,visibleLayersInfo:e,map:brApp.map,active:!0}},componentDidMount:function(){t.subscribe("refresh-legend",this.handleMapUpdate)},componentDidUpdate:function(){brApp.previousFamily="",brApp.previousGroup=""},objSort:function(){var e=arguments,t=e[0],n,r,i,s,o,u,a;return typeof arguments[arguments.length-1]=="boolean"?(n=arguments[arguments.length-1],r=arguments.length-1):(n=!1,r=arguments.length),t.sort(function(t,f){for(a=1;a<r;a++){i=e[a],typeof i!="string"?(s=i[1],i=i[0],o=t[e[a][0]],u=f[e[a][0]]):(s=!1,o=t[e[a]],u=f[e[a]]),n===!1&&typeof o=="string"&&o&&u&&(o=o.toLowerCase(),u=u.toLowerCase());if(!s){if(o<u)return-1;if(o>u)return 1}else{if(o>u)return-1;if(o<u)return 1}}return 0})},handleMapUpdate:function(){var e=this.dataGrabber();e.length===0?$(".legend-component-content").addClass("collapsed"):$(".legend-component-content").removeClass("collapsed"),e.forEach(function(e){e.layer.indexOf("indigenous")>-1?e.fakeLayer="indigenous":e.layer.indexOf("community")>-1&&(e.fakeLayer="community")}),this.objSort(e,["fakeLayer",!0],"group"),this.setState({visibleLayersInfo:e})},render:function(){return e.createElement("div",{id:"legend-container",className:"legend-container"},this.state.visibleLayersInfo.map(this.dataMapper,this))},dataMapper:function(t,n){var r=[];if(t.layer)for(var i=0;i<t.layers.length;i++)if(t.visibleLayers.indexOf(t.layers[i].layerId)>-1){var s={};s.group=t.group,s.layerName=t.layers[i].layerName,s.layerId=t.layers[i].layerId,s.legend=t.layers[i].legend,t.layer.indexOf("indigenous")>-1?s.family="Indigenous Lands":t.layer.indexOf("community")>-1?s.family="Community Lands":t.layer==="percentLands"?s.family="Percent of Indigenous & Community Lands":t.layer==="landTenure"&&(s.family="Indicators of Land Tenure Security"),(s.group!=="Formally recognized"&&s.group!=="Not formally recognized"||s.layerId!==0)&&r.push(s)}for(var o=0;o<r.length;o++)r[o].family!==brApp.previousFamily||r[o].family!=="Indigenous Lands"&&r[o].family!=="Community Lands"?brApp.previousFamily=r[o].family:r[o].family="",r[o].group!==brApp.previousGroup||r[o].group!=="Formally recognized"&&r[o].group!=="Not formally recognized"||!!r[o].family?brApp.previousGroup=r[o].group:r[o].group="";return e.createElement("div",{className:"layer-group"},r.map(function(t){return e.createElement("div",null,t.family?e.createElement("div",{className:"legend-item-family"},t.family):null,e.createElement("div",{className:"legend-item-group"},t.group),t.legend.map(function(t,n){return e.createElement("div",{className:"legend-item-name"},e.createElement("img",{className:"legend-item-img",src:"data:image/png;base64,"+t.imageData}),t.label)}))}))},dataGrabber:function(){var e=[];for(var t=0;t<brApp.layerInfos.length;t++){var n=brApp.map.getLayer(brApp.layerInfos[t].layerId);if(n.visible===!0&&n.visibleLayers.length>0&&n.visibleLayers[0]!==-1){var r,i,s;if(n.id.indexOf("indigenous")>-1)n.id.indexOf("Occupied")>-1||n.id.indexOf("FormalClaim")>-1?(r="Not formally recognized",i=n.id,s=n.visibleLayers):(r="Formally recognized",i=n.id,s=n.visibleLayers);else if(n.id.indexOf("community")>-1)n.id.indexOf("Occupied")>-1||n.id.indexOf("FormalClaim")>-1?(r="Not formally recognized",i=n.id,s=n.visibleLayers):(r="Formally recognized",i=n.id,s=n.visibleLayers);else if(n.id==="percentLands"){i=n.id,s=n.visibleLayers;switch(s[0]){case 1:r="Indigenous and Community Lands - Total";break;case 2:r="Indigenous and Community Lands - Formally recognized";break;case 3:r="Indigenous and Community Lands - Not formally recognized";break;case 5:r="Indigenous Lands (only) - Total";break;case 6:r="Indigenous Lands (only) - Formally recognized";break;case 7:r="Indigenous Lands (only) - Not formally recognized";break;case 9:r="Community Lands (only) - Total";break;case 10:r="Community Lands (only) - Formally recognized";break;case 11:r="Community Lands (only) - Not formally recognized"}}else n.id==="landTenure"&&(i=n.id,s=n.visibleLayers,s[0]===0||s[0]===1?r="Indicators of the Legal Security of Lands - Community":r="Indicators of the Legal Security of Lands - Indigenous");brApp.layerInfos[t].data.group=r,brApp.layerInfos[t].data.layer=i,brApp.layerInfos[t].data.visibleLayers=s,n.id.indexOf("Tiled")>-1?brApp.map.getZoom()<=7&&e.push(brApp.layerInfos[t].data):n.id.indexOf("community")>-1||n.id.indexOf("indigenous")>-1?brApp.map.getZoom()>7&&e.push(brApp.layerInfos[t].data):e.push(brApp.layerInfos[t].data)}}return e}}),s=e.createClass({displayName:"Legend",getInitialState:function(){return{collapsed:!1}},toggleActive:function(){var e;this.state.collapsed===!0?(e=!1,$("#toggleLegend").html("-")):(e=!0,$("#toggleLegend").html("+")),this.setState({collapsed:e})},toggleLayer:function(){this.setState({activeTab:this.state.activeTab==="community"?"national":"community"})},render:function(){return e.createElement("div",{className:"legend-component-container"+(this.state.collapsed?" collapsed":"")},e.createElement("div",{className:"legend-component-controls"},e.createElement("div",{className:"legend-controls"},"Legend",e.createElement("span",{id:"toggleLegend",onClick:this.toggleActive},"-"))),e.createElement("div",{id:"legend-component-content",className:"legend-component-content"+(this.state.collapsed?" collapsed":"")},e.createElement(i,null)))}});return function(t){return e.render(e.createElement(s,null),document.getElementById(t))}}),define("map/MapController",["main/config","map/Map","map/Uploader","map/DrawTool","map/MapConfig","map/MapAssets","components/LayerTabContainer","components/LegendComponent","map/WidgetsController","utils/Helper","dojo/on","dojo/query","dojo/dom-class","dojo/dom-construct","dojo/_base/array","dojo/promise/all","dojo/Deferred","dojo/number","dojo/topic","dojo/fx/Toggler","dijit/registry","dijit/layout/ContentPane","esri/dijit/Legend","esri/dijit/HomeButton","esri/dijit/BasemapGallery","esri/dijit/Scalebar","esri/request","esri/geometry/Point","esri/geometry/Polygon","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/InfoTemplate","esri/tasks/query","esri/tasks/QueryTask","dijit/form/HorizontalSlider","dijit/form/HorizontalRuleLabels","esri/layers/LayerDrawingOptions"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B){"use strict";var j,F,I={init:function(){brApp.debug("MapController >>> init"),esri.config.defaults.io.corsEnabledServers.push("http://gis.wri.org");var s=this,o=new t(i.options);brApp.map=o.map,o.on("map-ready",function(){s.renderComponents()}),l(document.getElementById("basemap-button"),"click",a.toggleBasemapGallery.bind(a)),l(document.getElementById("share-button"),"click",a.toggleShareContainer.bind(a)),l(document.getElementById("print-button"),"click",a.printMap),l(document.getElementById("tree-container-toggle"),"click",a.toggleTreeContainer),l(document.getElementById("analysis-button"),"click",function(){if(this.classList.contains("grayOut"))return;var e=brApp.map.getLayer("CustomFeatures");a.showAnalysisDialog(e)}),l(document.getElementById("upload-shapefile"),"click",a.toggleUploadForm),l(document.getElementById("draw-shape"),"click",r.activate),l(document.getElementById("remove-graphics"),"click",s.removeAllGraphics),l(document.uploadForm,"change",n.beginUpload.bind(n)),l(brApp.map,"click",s.handleClick.bind(s)),l(brApp.map,"layer-add-result",function(e){e.layer.id==="CustomFeatures"&&l(brApp.map.getLayer("CustomFeatures"),"click",function(e){s.selectCustomGraphics(e)})}),l(brApp.map,"extent-change",function(e){if(e.levelChange!==!0)return;for(var t in i.layers)if(i.layers[t].type==="tiled"){var n=document.getElementById("legend_"+t);e.lod.level>7&&n?n.classList.add("hideLegend"):e.lod.level<=7&&n&&n.classList.remove("hideLegend")}console.log(e.lod.level)}),l(brApp.map,"layers-add-result",function(e){var t=e.layers.map(function(e){var t={layer:e.layer};switch(e.layer.id){case"percentLands":t.hideLayers=[];break;case"landTenure":t.hideLayers=[];break;default:t.hideLayers=[0]}return t}),n=e.layers.filter(function(e){var t=e.layer.url;return t}).map(function(e){var t=e.layer.url;if(t)var n=[t,"legend"].join("/");var r=new m;return s.esriRequestCall(n,{f:"json"}).then(function(t){r.resolve({layerId:e.layer.id,data:t})}),r});v(n).then(function(e){brApp.layerInfos=e;var t=new u("legend-component");y.publish("legend-loaded"),l(document.getElementById("layersMenuButton"),"click",a.toggleMobileMenuContainer),l(document.getElementById("legendMenuButton"),"click",a.toggleMobileMenuContainer),l(document.getElementById("toolsMenuButton"),"click",a.toggleMobileMenuContainer)})}),l(document.getElementById("mobile-menu-toggle"),"click",a.toggleMobileMenu),l(document.getElementById("mobile-menu-close"),"click",a.toggleMobileMenu),l(document.getElementById("embedShare"),"click",a.showEmbedCode),C.setRequestPreCallback(function(t){if(t.url!==e.printUrl+"/execute")return t;if(brApp.map.getZoom()>8){var n=JSON.parse(t.content.Web_Map_as_JSON),r=n.layoutOptions.legendOptions.operationalLayers;return r.forEach(function(e){e.subLayerIds&&e.subLayerIds.length===2&&(e.subLayerIds=e.subLayerIds.slice(1))}),n.layoutOptions.legendOptions.operationalLayers=r,t.content.Web_Map_as_JSON=JSON.stringify(n),t}var n=JSON.parse(t.content.Web_Map_as_JSON),r=n.layoutOptions.legendOptions.operationalLayers,i=brApp.map.layerIds.filter(function(e){return e.search("Tiled")>-1});return i.forEach(function(e){var t=brApp.map.getLayer(e);t&&t.visible&&t.visibleAtMapScale&&r.push({id:t.id,subLayerIds:t.visibleLayers.slice(1)})}),n.layoutOptions.legendOptions.operationalLayers=r,t.content.Web_Map_as_JSON=JSON.stringify(n),t})},renderComponents:function(){brApp.debug("MapController >>> renderComponents");var e,t=this,n,i,s,u,f;f=c(".esriSimpleSliderIncrementButton")[0],p.create("div",{id:"homeButton",title:"Default map extent"},f,"after"),s=new x({map:brApp.map},"homeButton"),e=new T({map:brApp.map,showArcGISBasemaps:!0},"basemap-gallery"),u=new N({map:brApp.map,attachTo:"bottom-center",scalebarUnit:"metric"}),n=new o("layer-content"),e.startup(),s.startup(),t.getLandTenureRenderer(),r.init(),l(document.getElementById("analysis-help"),"click",a.showHelp),c("body .hideOnLoad").forEach(function(e){h.remove(e,"hideOnLoad")})},esriRequestCall:function(e,t){var n=new m,r=esri.request({url:e,content:t,handleAs:"json"},{usePost:!0});return r.then(function(e){n.resolve(e)},function(e){console.log("Error: ",e.message),n.resolve(e)}),n},resetCommunityLevelTree:function(){F&&F.toggleOff()},resetNationalLayerList:function(){j&&j.setToNone()},handleClick:function(e){brApp.debug("MapController >>> handleClick");var t=e.mapPoint,n=[],i=[],s=this,o,u,a,f,c,h,p,m,g,y,b,w,E,S;brApp.mapPoint=t,brApp.mapPoint.clientY=e.clientY,brApp.mapPoint.clientX=e.clientX,brApp.map.infoWindow.clearFeatures(),brApp.map.infoWindow.isShowing&&brApp.map.infoWindow.hide();if(r.isActive())return;o=brApp.map.getLayer("indigenous_FormalClaim"),u=brApp.map.getLayer("indigenous_FormalDoc"),a=brApp.map.getLayer("indigenous_InProcess"),f=brApp.map.getLayer("indigenous_NoDoc"),c=brApp.map.getLayer("indigenous_Occupied"),h=brApp.map.getLayer("community_FormalClaim"),p=brApp.map.getLayer("community_FormalDoc"),m=brApp.map.getLayer("community_InProcess"),g=brApp.map.getLayer("community_NoDoc"),y=brApp.map.getLayer("community_Occupied"),o&&o.visible&&n.push(s.identifyIndigenous_FormalClaims(t)),u&&u.visible&&n.push(s.identifyIndigenous_FormalDoc(t)),a&&a.visible&&n.push(s.identifyIndigenous_InProcess(t)),f&&f.visible&&n.push(s.identifyIndigenous_NoDoc(t)),c&&c.visible&&n.push(s.identifyIndigenous_Occupied(t)),h&&h.visible&&n.push(s.identifyCommunity_FormalClaim(t)),p&&p.visible&&n.push(s.identifyCommunity_FormalDoc(t)),m&&m.visible&&n.push(s.identifyCommunity_InProcess(t)),g&&g.visible&&n.push(s.identifyCommunity_NoDoc(t)),y&&y.visible&&n.push(s.identifyCommunity_Occupied(t)),b=brApp.map.getLayer("percentLands"),b&&b.visible&&n.push(s.identifyPercentLayer(t)),w=brApp.map.getLayer("landTenure"),w&&w.visible&&w.visibleLayers.indexOf(-1)!==0&&n.push(s.identifyLandTenure(t));if(n.length===0)return;v(n).then(function(e){d.forEach(e,function(e){switch(e.layer){case"indigenous_FormalClaim":i=i.concat(s.setIndigenousTemplates(e.features));break;case"indigenous_FormalDoc":i=i.concat(s.setIndigenousTemplates(e.features));break;case"indigenous_InProcess":i=i.concat(s.setIndigenousTemplates(e.features));break;case"indigenous_NoDoc":i=i.concat(s.setIndigenousTemplates(e.features));break;case"indigenous_Occupied":i=i.concat(s.setIndigenousTemplates(e.features));break;case"community_FormalClaim":i=i.concat(s.setCommunityTemplates(e.features));break;case"community_FormalDoc":i=i.concat(s.setCommunityTemplates(e.features));break;case"community_InProcess":i=i.concat(s.setCommunityTemplates(e.features));break;case"community_NoDoc":i=i.concat(s.setCommunityTemplates(e.features));break;case"community_Occupied":i=i.concat(s.setCommunityTemplates(e.features));break;case"landTenure":i=i.concat(s.setLandTenureTemplates(e.features));break;case"percentLands":i=i.concat(s.setPercentLandsTemplates(e.features));break;default:}}),i.length>0&&(brApp.map.infoWindow.setFeatures(i),brApp.map.infoWindow.resize(450,600),$(".esriPopup .titleButton.close").css("background-image",'url("css/images/close_x_symbol.png")'),$("#identifyNote").remove(),brApp.map.infoWindow.show(t),window.innerWidth<1e3&&(brApp.map.infoWindow.maximize(),$(".esriPopup .contentPane").css("height","inherit")),l.once(brApp.map.infoWindow,"hide",function(){brApp.map.infoWindow.resize(450,600)}))})},identifyIndigenous_FormalClaims:function(e){brApp.debug("MapController >>> identifyIndigenous_FormalClaims");var t=new m,n=new A(i.layers.indigenous_FormalClaim.url),r=new O,s=brApp.map.getLayer("indigenous_FormalClaim");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"indigenous_FormalClaim",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyIndigenous_FormalDoc:function(e){brApp.debug("MapController >>> identifyIndigenous_FormalDoc");var t=new m,n=new A(i.layers.indigenous_FormalDoc.url),r=new O,s=brApp.map.getLayer("indigenous_FormalDoc");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"indigenous_FormalDoc",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyIndigenous_InProcess:function(e){brApp.debug("MapController >>> identifyIndigenous_InProcess");var t=new m,n=new A(i.layers.indigenous_InProcess.url),r=new O,s=brApp.map.getLayer("indigenous_InProcess");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"indigenous_InProcess",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyIndigenous_NoDoc:function(e){brApp.debug("MapController >>> identifyIndigenous_NoDoc");var t=new m,n=new A(i.layers.indigenous_NoDoc.url),r=new O,s=brApp.map.getLayer("indigenous_NoDoc");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"indigenous_NoDoc",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyIndigenous_Occupied:function(e){brApp.debug("MapController >>> identifyIndigenous_Occupied");var t=new m,n=new A(i.layers.indigenous_Occupied.url),r=new O,s=brApp.map.getLayer("indigenous_Occupied");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"indigenous_Occupied",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyCommunity_FormalClaim:function(e){brApp.debug("MapController >>> identifyCommunity_FormalClaim");var t=new m,n=new A(i.layers.community_FormalClaim.url),r=new O,s=brApp.map.getLayer("community_FormalClaim");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"community_FormalClaim",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyCommunity_FormalDoc:function(e){brApp.debug("MapController >>> identifyCommunity_FormalDoc");var t=new m,n=new A(i.layers.community_FormalDoc.url),r=new O,s=brApp.map.getLayer("community_FormalDoc");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"community_FormalDoc",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyCommunity_InProcess:function(e){brApp.debug("MapController >>> identifyCommunity_InProcess");var t=new m,n=new A(i.layers.community_InProcess.url),r=new O,s=brApp.map.getLayer("community_InProcess");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"community_InProcess",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyCommunity_NoDoc:function(e){brApp.debug("MapController >>> identifyCommunity_NoDoc");var t=new m,n=new A(i.layers.community_NoDoc.url),r=new O,s=brApp.map.getLayer("community_NoDoc");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"community_NoDoc",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyCommunity_Occupied:function(e){brApp.debug("MapController >>> identifyCommunity_Occupied");var t=new m,n=new A(i.layers.community_Occupied.url),r=new O,s=brApp.map.getLayer("community_Occupied");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"community_Occupied",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyPercentLayer:function(e){brApp.debug("MapController >>> identifyPercentLayer");var t=new m,n=new A(i.layers.percentLands.url),r=new O,s=brApp.map.getLayer("percentLands");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"percentLands",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},identifyLandTenure:function(e){brApp.debug("MapController >>> identifyLandTenure");var t=new m,n=new A(i.layers.landTenure.url),r=new O,s=brApp.map.getLayer("landTenure");return r.tolerance=3,r.returnGeometry=!0,r.maxAllowableOffset=Math.floor(brApp.map.extent.getWidth()/brApp.map.width),r.width=brApp.map.width,r.height=brApp.map.height,r.geometry=e,r.mapExtent=brApp.map.extent,r.layerIds=s.visibleLayers,r.layerOption=O.LAYER_OPTION_VISIBLE,n.execute(r,function(e){e.length>0?t.resolve({layer:"landTenure",features:e}):t.resolve(!1)},function(e){t.resolve(!1)}),t.promise},setCommunityTemplates:function(e){brApp.debug("MapController >>> setCommunityTemplates");var t,n=[],r;return self=this,d.forEach(e,function(e){var i,s=e.feature.attributes.Ethncty_1,o=e.feature.attributes.Ethncty_2,u=e.feature.attributes.Ethncty_3;!s||s==" "?i="Unknown":s&&!o?i=s:s&&o&&!u?i=s+", "+o:i=s+", "+o+", "+u;var a,f=e.feature.attributes.Populatn=="Null"?null:e.feature.attributes.Populatn,l=e.feature.attributes.Pop_Source=="Null"?null:e.feature.attributes.Pop_Source,c=e.feature.attributes.Pop_Year=="Null"?null:e.feature.attributes.Pop_Year;!f||f=="0"?a="Unknown":f&&!l?a=f:f&&l&&(!c||c==0)?a=f+" - "+l:a=f+" - "+l+", "+c;for(var h in e.feature.attributes)if(e.feature.attributes[h]=="Null"||e.feature.attributes[h]=="null"||e.feature.attributes[h]==""||e.feature.attributes[h]==" ")e.feature.attributes[h]="Unknown";e.feature.attributes.Stat_Date!=="Unknown"?r=" ("+e.feature.attributes.Stat_Date+")":r="",t=new M(e.value,"<div id='tableWrapper'><table id='indigenousTable'><tr class='even-row'><td class='popup-header'>Country</td><td>"+e.feature.attributes.Country+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Identity</td><td>"+e.feature.attributes.Identity+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Recognition status</td><td>"+e.feature.attributes.Form_Rec+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Documentation status (Date)</td><td>"+e.feature.attributes.Doc_Status+r+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Land category</td><td>"+e.feature.attributes.Category+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Ethnic groups</td><td>"+i+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Population</td><td>"+a+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Land Area</td><td>Official area (ha): "+self.numberWithCommas(e.feature.attributes.Area_Ofcl)+"<br>GIS area (ha): "+self.numberWithCommas(e.feature.attributes.Area_GIS)+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Acquisition scale</td><td>"+e.feature.attributes.Scale+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Acquisition method</td><td>"+e.feature.attributes.Method+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Data source</td><td>"+e.feature.attributes.Data_Src+" ("+e.feature.attributes.Data_Date+")</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Data Contributor</td><td>"+e.feature.attributes.Data_Ctrb+"</td></tr></table></div>"+"<div class='popup-last'>Date uploaded: "+e.feature.attributes.Upl_Date),e.feature.attributes.More_info==" "||e.feature.attributes.More_info==""||e.feature.attributes.More_info=="Unknown"?t.content+="</div>":t.content+="<div><a href="+e.feature.attributes.More_info+' target="_blank" id="additionalInfo">More Info</a></div></div>',t.content="<div>"+t.content+"</div>",e.feature.setInfoTemplate(t),n.push(e.feature)}),n},setIndigenousTemplates:function(e){brApp.debug("MapController >>> setIndigenousTemplates");var t,n=[],r;return self=this,d.forEach(e,function(e){var i,s=e.feature.attributes.Ethncty_1,o=e.feature.attributes.Ethncty_2,u=e.feature.attributes.Ethncty_3;!s||s==" "?i="Unknown":s&&!o?i=s:s&&o&&!u?i=s+", "+o:i=s+", "+o+", "+u;var a,f=e.feature.attributes.Populatn=="Null"?null:e.feature.attributes.Populatn,l=e.feature.attributes.Pop_Source=="Null"?null:e.feature.attributes.Pop_Source,c=e.feature.attributes.Pop_Year=="Null"?null:e.feature.attributes.Pop_Year;!f||f=="0"?a="Unknown":f&&!l?a=f:f&&l&&(!c||c==0)?a=f+" - "+l:a=f+" - "+l+", "+c;for(var h in e.feature.attributes)if(e.feature.attributes[h]=="Null"||e.feature.attributes[h]=="null"||e.feature.attributes[h]==""||e.feature.attributes[h]==" ")e.feature.attributes[h]="Unknown";e.feature.attributes.Stat_Date!=="Unknown"?r=" ("+e.feature.attributes.Stat_Date+")":r="",t=new M(e.value,"<div id='tableWrapper'><table id='indigenousTable'><tr class='even-row'><td class='popup-header'>Country</td><td>"+e.feature.attributes.Country+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Identity</td><td>"+e.feature.attributes.Identity+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Recognition status</td><td>"+e.feature.attributes.Form_Rec+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Documentation status (Date)</td><td>"+e.feature.attributes.Doc_Status+r+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Land category</td><td>"+e.feature.attributes.Category+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Ethnic groups</td><td>"+i+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Population</td><td>"+a+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Land Area</td><td>Official area (ha): "+self.numberWithCommas(e.feature.attributes.Area_Ofcl)+"<br>GIS area (ha): "+self.numberWithCommas(e.feature.attributes.Area_GIS)+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Acquisition scale</td><td>"+e.feature.attributes.Scale+"</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Acquisition method</td><td>"+e.feature.attributes.Method+"</td></tr>"+"<tr class='even-row'><td class='popup-header'>Data source</td><td>"+e.feature.attributes.Data_Src+" ("+e.feature.attributes.Data_Date+")</td></tr>"+"<tr class='odd-row'><td class='popup-header'>Data Contributor</td><td>"+e.feature.attributes.Data_Ctrb+"</td></tr></table></div>"+"<div class='popup-last'>Date uploaded: "+e.feature.attributes.Upl_Date),e.feature.attributes.More_info==" "||e.feature.attributes.More_info==""||e.feature.attributes.More_info=="Unknown"?t.content+="</div>":t.content+="<div><a href="+e.feature.attributes.More_info+' target="_blank" id="additionalInfo">More Info</a></div></div>',t.content="<div>"+t.content+"</div>",e.feature.setInfoTemplate(t),n.push(e.feature)}),n},setPercentLandsTemplates:function(e){brApp.debug("MapController >>> setPercentLandsTemplates");var t,n=[],r=this;return d.forEach(e,function(e){t=new M(e.feature.attributes.Country,"");for(var r in e.feature.attributes)if(!e.feature.attributes[r]||e.feature.attributes[r]==="undefined"||e.feature.attributes[r]=="Null"||e.feature.attributes[r]=="null"||e.feature.attributes[r]==""||e.feature.attributes[r]==" ")r.indexOf("Notes")==-1?e.feature.attributes[r]="Unknown":e.feature.attributes[r]="None";var i=e.feature.attributes.IC_Notes?"<tr class='odd-row'><td class='popup-header nationalField'>Notes</td><td>"+e.feature.attributes.IC_Notes+"</td></tr>":"",s=e.feature.attributes.IC_Notes?"<tr class='odd-row'><td class='popup-header nationalField'>Notes</td><td>"+e.feature.attributes.I_Notes+"</td></tr>":"",o=e.feature.attributes.IC_Notes?"<tr class='odd-row'><td class='popup-header nationalField'>Notes</td><td>"+e.feature.attributes.C_Notes+"</td></tr>":"";t.content="<div id='tableWrapper'><table id='nationalTable'><tr class='even-row'><td class='popup-header nationalField'>Percent of country area held or used by Indigenous peoples and communities</td><td><div>Total: "+e.feature.attributes.IC_T+"% "+e.feature.attributes.IC_T_Src+'</div><div class="indentTD">Formally recognized: '+e.feature.attributes.IC_F+"% "+e.feature.attributes.IC_F_Src+'</div><div class="indentTD">Not formally recognized: '+e.feature.attributes.IC_NF+"% "+e.feature.attributes.IC_NF_Src+"</div></td></tr>"+i+"<tr class='even-row'><td class='popup-header nationalField'>Percent of country area held or used by Indigenous peoples only</td><td><div>Total: "+e.feature.attributes.I_T+"% "+e.feature.attributes.I_T_Src+'</div><div class="indentTD">Formally recognized: '+e.feature.attributes.I_F+"% "+e.feature.attributes.I_F_Src+'</div><div class="indentTD">Not formally recognized: '+e.feature.attributes.I_NF+"% "+e.feature.attributes.I_NF_Src+"</div></td></tr>"+s+"<tr class='even-row'><td class='popup-header nationalField'>Percent of country area held or used by communities only</td><td><div>Total: "+e.feature.attributes.C_T+"% "+e.feature.attributes.C_T_Src+'</div><div class="indentTD">Formally recognized: '+e.feature.attributes.C_F+"% "+e.feature.attributes.C_F_Src+'</div><div class="indentTD">Not formally recognized: '+e.feature.attributes.C_NF+"% "+e.feature.attributes.C_NF_Src+"</div></td></tr>"+o+"</table></div>"+"<div class='popup-last'>Date uploaded: "+e.feature.attributes.Upl_Date+"<a href='./data/' target='_blank' class='popup-last-right'>More Info</a></div>",e.feature.setInfoTemplate(t),n.push(e.feature)}),console.log(n),n},setLandTenureTemplates:function(e){brApp.debug("MapController >>> setLandTenureTemplates");var t,n=[],r=s.getNationalLevelIndicatorCode(),i=this;return d.forEach(e,function(e){t=new M(e.value,"");for(var i in e.feature.attributes)if(e.feature.attributes[i]=="Null"||e.feature.attributes[i]=="null"||e.feature.attributes[i]==""||e.feature.attributes[i]==" ")console.log(e.feature.attributes[i]),e.feature.attributes[i]="Unknown";console.log("item.layerId",e.layerId),e.layerId===0||e.layerId===2?t.content="<div id='tableWrapper'><table id='landTenureTable'><tr class='even-row'><td class='popup-header nationalField'>Groups targeted by the legal framework</td><td>"+e.feature.attributes.Framework+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Language of the law review</td><td>"+e.feature.attributes.Language+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Average Indicator Score</td><td>"+e.feature.attributes.Avg_Scr+"</td></tr>"+"<tr class='full-row'><td colspan='2' class='popup-header'>Scores per Indicator</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Q1: Legal Status</td><td>"+e.feature.attributes.I1_Scr+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Q2: Land Rights and Common Property</td><td>"+e.feature.attributes.I2_Scr+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Q3: Formal Documentation</td><td>"+e.feature.attributes.I3_Scr+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Q4: Legal Person</td><td>"+e.feature.attributes.I4_Scr+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Q5: Legal Authority</td><td>"+e.feature.attributes.I5_Scr+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Q6: Perpetuity</td><td>"+e.feature.attributes.I6_Scr+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Q7: Right to Consent Before Land Acquisition</td><td>"+e.feature.attributes.I7_Scr+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Q8: Rights to Trees</td><td>"+e.feature.attributes.I8_Scr+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Q9: Rights to Water</td><td>"+e.feature.attributes.I9_Scr+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Q10: Land Rights in Protected Areas</td><td>"+e.feature.attributes.I10_Scr+"</td></tr></table></div>"+"<div class='popup-last'>Date uploaded: "+e.feature.attributes.Upl_Date+"<a href='http://www.blueraster.com' target='_blank' class='popup-last-right'>More Info</a></div>":t.content="<div id='tableWrapper'><table id='landTenureTable'><tr class='even-row'><td class='popup-header nationalField'>Groups targeted by the legal framework</td><td>"+e.feature.attributes.Framework+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Language of the law review</td><td>"+e.feature.attributes.Language+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Indicator score</td><td>"+e.feature.attributes["I"+r+"_Scr"]+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Justification of score</td><td>"+e.feature.attributes["I"+r+"_Com"]+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Laws and provisions reviewed</td><td>"+e.feature.attributes["I"+r+"_LaP"]+"</td></tr>"+"<tr class='odd-row'><td class='popup-header nationalField'>Additional comments</td><td>"+e.feature.attributes["I"+r+"_AddInfo"]+"</td></tr>"+"<tr class='even-row'><td class='popup-header nationalField'>Review source (Year)</td><td>"+e.feature.attributes["I"+r+"_Rev"]+"("+e.feature.attributes["I"+r+"_Year"]+")</td></tr></table></div>"+"<div class='popup-last'>Date uploaded: "+e.feature.attributes.Upl_Date+"<a href='http://www.blueraster.com' target='_blank' class='popup-last-right'>More Info</a></div>",e.feature.setInfoTemplate(t),n.push(e.feature)}),console.log(n),n},setCustomNationalTemplate:function(e){brApp.debug("MapController >>> setCustomNationalTemplate");var t,n,r,i,o,u,a,f=s.getNationalLevelIndicatorCode(),l="I"+f+"_Scr";f==="Avg_Scr"&&(l=f);var c=e.attributes[l];console.log(c);switch(c){case"0":t="No review yet done";break;case"1":t="The law is either silent on an issue or there is express exclusion";break;case"2":t="The legal framework addresses the indicator but not substantively";break;case"3":t="The legal framework substantially meets the indicator";break;case"4":t="The legal framework fully meets the indicator";break;case"9":t="The indicator is not applicable"}for(var h in e.attributes)e.attributes[h]=="Null"&&(e.attributes[h]="Unknown");n=e.attributes.Framework,r=e.attributes["I"+f+"_Com"],i=e.attributes["I"+f+"_LaP"],o=e.attributes["I"+f+"_Rev"],u=e.attributes["I"+f+"_Year"],a=e.attributes.Upl_Date;var p=new M("${Country}","<div id='tableWrapper'><table id='landTenureTable'><tr class='odd-row'><td class='popup-header tenureField'>Groups targeted by the legal framework</td><td>"+n+"</td></tr>"+"<tr class='even-row'><td class='popup-header tenureField'>Indicator score</td><td>"+t+"</td></tr>"+"<tr class='odd-row'><td class='popup-header tenureField'>Comments</td><td>"+r+"</td></tr>"+"<tr class='even-row'><td class='popup-header tenureField'>Laws and provisions reviewed</td><td>"+i+"</td></tr>"+"<tr class='odd-row'><td class='popup-header tenureField'>Review source and date</td><td>"+r+"</td></tr></table></div>"+"<div class='popup-last'>Last Updated: "+a+"</div>");return p},selectCustomGraphics:function(e){brApp.debug("MapController >>> selectCustomGraphics"),brApp.mapPoint=e;var t=e.graphic,n=brApp.map.getLayer("CustomFeatures"),r=brApp.map.getLayer("analysisLayer"),i=this,s=[],o,u,a;e.stopPropagation(),brApp.map.infoWindow.isShowing&&brApp.map.infoWindow.hide();var f=function(e){console.log(e)},c=new m,h=new A(r.url),p=new O;p.tolerance=3,p.returnGeometry=!1,p.width=brApp.map.width,p.height=brApp.map.height,p.geometry=e.graphic.geometry,p.mapExtent=brApp.map.extent,p.layerIds=r.visibleLayers,p.layerOption=O.LAYER_OPTION_VISIBLE,p.layerIds.indexOf(17)>-1&&p.layerIds.splice(p.layerIds.indexOf(17),1),h.execute(p,function(n){if(n.length>0)c.resolve({layer:"indigenousLands",features:n});else{console.log("no feats returned");var r=new M;r.setContent("<b>The area of interest intersects with <i>Zero</i> indigenous and/or community lands</b><button id='removeGraphic'>Remove</button>"),brApp.map.infoWindow.setContent(r.content),brApp.map.infoWindow.setTitle("Analysis Results"),$(".esriPopup .titleButton.close").css("background-image",'url("css/images/close_x_symbol.png")'),$("#identifyNote").remove(),brApp.map.infoWindow.show(e);var s=l.once(document.getElementById("removeGraphic"),"click",function(){i.removeCustomGraphic(t.attributes.attributeID),brApp.map.infoWindow.hide()});l.once(brApp.map.infoWindow,"hide",function(){s.remove()}),c.resolve(!1)}},function(e){c.resolve(!1)}),c.then(function(e){function s(e,t){e.feature.attributes.Identity==="Indigenous (self-identified)"&&(e.feature.attributes.Identity="Indigenous"),e.feature.attributes.Identity==="Non-indigenous (self-identified)"&&(e.feature.attributes.Identity="Community"),e.feature.attributes.Form_Rec==="Officially recognized (by law or decree)"&&(e.feature.attributes.Form_Rec="Officially recognized");var n;if(t==="even"){n="<tr class='even-row'><td class='country'>"+e.feature.attributes.Country+"</td><td class='name'>"+e.feature.attributes.Name+"</td><td class='ident'>"+e.feature.attributes.Identity+"</td><td class='offic_rec'>"+e.feature.attributes.Form_Rec+"</td><td class='rec_status'>"+e.feature.attributes.Doc_Status+"</td></tr>";var r=[e.feature.attributes.Country,e.feature.attributes.Name,e.feature.attributes.Identity,e.feature.attributes.Form_Rec,e.feature.attributes.Form_Rec];brApp.csv+=r.join(",")+"\n"}else{n="<tr class='odd-row'><td>"+e.feature.attributes.Country+"</td><td class='name'>"+e.feature.attributes.Name+"</td><td class='ident'>"+e.feature.attributes.Identity+"</td><td class='offic_rec'>"+e.feature.attributes.Form_Rec+"</td><td class='rec_status'>"+e.feature.attributes.Doc_Status+"</td></tr>";var r=[e.feature.attributes.Country,e.feature.attributes.Name,e.feature.attributes.Identity,e.feature.attributes.Form_Rec,e.feature.attributes.Form_Rec];brApp.csv+=r.join(",")+"\n"}return n}if(!e)return;var n=new M;n.setContent("<table id='analysisTable'><tr id='column-header'><td class='country'><b>Country</b></td><td class='name'><b>Name</b></td><td class='ident'><b>Identity</b></td><td class='offic_rec'><b>Formal Recognition</b></td><td class='rec_status'><b>Documentation Status</b></td></tr><tr id='fillerColumn' style='height: 36px;'><td><b></b></td><td><b></b></td><td><b></b></td><td><b></b></td><td><b></b></td></tr>");var r=["Country","Name","Identity","Formal Recognition","Documentation Status"];brApp.csv=r.join(",")+"\n";for(var o=0;o<e.features.length;o++)o%2==0?n.content=n.content+s(e.features[o],"even"):n.content=n.content+s(e.features[o],"odd");n.content+="</table>";var u="<div id='title_title'>Analysis Results</div>",a="<div id='titleResults'><i>The area of interest intersects with "+e.features.length+" indigenous and/or community lands</i></div>";brApp.map.infoWindow.setTitle(u+a),brApp.map.infoWindow.setContent(n.content),brApp.map.infoWindow.resize(650,350),$("#identifyNote").remove();var f="<div id='identifyNote'><div id='buttonBox'><button id='removeGraphic'>Remove</button><button id='exportAnalysis'>Export Analysis</button></div><div style='padding:15px;'>Note that the results of this analysis are only as complete as the data available on the platform. Additional indigenous and community lands may be present but are not contained in the available dataset; therefore, a local analysis is always recommended. The Data Completeness layer provides a broad assesment of the completeness of the indigenous and community lands data layer for a reference.</div></div>";$(".esriPopupWrapper").append(f),$(".esriPopupWrapper").addClass("noPositioning"),$(".esriPopup .titleButton.close").css("background-image",'url("css/images/close_x_symbol.png")'),d.forEach(brApp.map.infoWindow.domNode.children,function(e){if(e){var t=e.cloneNode(!0);$("#infowindowContainer").append(t)}});var c=e.features.length*44+210;c+="px",$("#infowindowContainer").css("height",c),$("#infowindowContainer").show();var h=l.once(document.getElementById("removeGraphic"),"click",function(){i.removeCustomGraphic(t.attributes.attributeID),$("#infowindowContainer").html(""),$("#infowindowContainer").hide(),$(".esriPopupWrapper").removeClass("noPositioning")});$("div.titleButton.close").click(function(){$("#infowindowContainer").html(""),$("#infowindowContainer").hide(),h.remove(),$(".esriPopupWrapper").removeClass("noPositioning")});var p=$("#analysisTable").parent()[0],v=$("#analysisTable")[0];l.once(document.getElementById("exportAnalysis"),"click",function(){i.exportAnalysisResult(brApp.csv)})})},removeCustomGraphic:function(e){var t=brApp.map.getLayer("CustomFeatures"),n;d.some(t.graphics,function(t){return t.attributes.attributeID===e?(n=t,!0):!1}),n&&t.remove(n)},removeAllGraphics:function(){var e=brApp.map.getLayer("CustomFeatures");e.clear(),e.redraw(),$("#remove-graphics").addClass("hidden"),$("#draw-shape").removeClass("display-three"),$("#upload-shapefile").removeClass("display-three")},getLandTenureRenderer:function(){brApp.debug("MapController >>> getLandTenureRenderer");var e=C({url:"http://gis.wri.org/arcgis/rest/services/IndigenousCommunityLands/NationalLevel/MapServer/0",content:{f:"json"},callbackParamName:"callback"});e.then(function(e){var t,n,r,i,s,o,u;brApp.landTenureRenderer=e.drawingInfo.renderer})},handleNationalToggle:function(e){brApp.debug("MapController >>> handleNationalToggle");var t=e.target?e.target:e.srcElement,n=document.querySelector(".national-segmented-menu-button.active"),r;if(h.contains(t,"active"))return;n&&h.remove(n,"active");switch(t.id){case"nationalCommunityMenuButton":r="national-level-tree-community",h.add("national-level-tree-indigenous","hidden"),h.remove("national-level-tree-percentage","hidden");break;case"nationalIndigenousMenuButton":r="national-level-tree-indigenous",h.remove("national-level-tree-indigenous","hidden"),h.add("national-level-tree-percentage","hidden"),h.remove;break;case"nationalPercentageMenuButton":r="national-level-tree-percentage",h.add("national-level-tree-indigenous","hidden"),h.add("national-level-tree-community","hidden");break;case"land-tenure-toggle":r="national-level-data-container",h.add("national-level-tree-percentage","hidden"),h.remove("national-level-data-container","hidden");break;case"percent-national-toggle":r="national-level-tree-percentage",h.remove("national-level-tree-percentage","hidden"),h.add("national-level-data-container","hidden");case"none-toggle":h.add("national-level-data-container","hidden"),h.add("national-level-tree-percentage","hidden")}h.add(t,"active")},exportAnalysisResult:function(e){brApp.debug("MapController >>> exportAnalysisResult");var t=new Blob([e],{type:"text/csv;charset=utf-8;"});saveAs(t,"LandMarkAnalysisResults.csv")},numberWithCommas:function(e){var t=e.toString().split(".");return t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t[0]},printAnalysis:function(e){brApp.debug("MapController >>> printAnalysis"),window.print()}};return I}),define("main/Dispatcher",["dojo/topic","map/MapController"],function(e,t){"use strict";var n={listen:function(){brApp.debug("Dispatcher >>> listen"),e.subscribe("reset-community-tree",t.resetCommunityLevelTree),e.subscribe("reset-national-layer-list",t.resetNationalLayerList)}};return n}),define("main/AppController",["dojo/on","dojo/topic","dijit/registry","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/cookie","utils/Helper","map/WidgetsController","components/LegendComponent"],function(e,t,n,r,i,s,o,u,a,f){"use strict";var l={init:function(){brApp.debug("AppController >>> init"),this.overrideEvents(),this.bindEvents()},overrideEvents:function(){brApp.debug("AppController >>> overrideEvents")},bindEvents:function(){brApp.debug("AppController >>> bindEvents");var e=this;t.subscribe("changedLayout",function(t){t?e.layoutChangedToMobile():e.layoutChangedToDesktop()}),t.subscribe("legend-loaded",function(){u.isMobile()&&this.layoutChangedToMobile()}.bind(this))},overrideNav:function(e){brApp.debug("AppController >>> overrideNav"),$(".toggle-topbar").click(),$(".top-bar").css("height","auto"),e.preventDefault();var t=e.target?e.target:e.srcElement;t.id==="map-page-link"&&a.showWelcomeDialog()},layoutChangedToMobile:function(){brApp.debug("AppController >>> layoutChangedToMobile");var e=document.getElementById("mobile-legend-content"),t=document.getElementById("mobile-layers-content"),r=document.getElementById("mobile-tools-content"),i=document.getElementById("layer-content");s.place(i,t,"last"),$("#layer-content").css("height")==="0px"&&$("#layer-content").css("height","auto");var o=document.getElementById("legend-component"),u=new f("legend-component2"),a=document.getElementById("analysis-content");s.place(a,r,"first");var l=n.byId("layer-accordion");l&&l.resize()},layoutChangedToDesktop:function(){brApp.debug("AppController >>> layoutChangedToDesktop");var e=document.getElementById("brMap"),t=document.getElementById("tree-widget-container"),o=document.getElementById("layer-content");s.place(o,t,"last");var u=document.getElementById("analysis-content");n.byId("analysis-dialog").setContent(u),r.set("brMap","left","0"),i.remove("mobileMenu","open")}};return l}),define("main/Main",["esri/config","main/config","utils/Helper","utils/HashController","dojo/io-query","main/Dispatcher","map/MapController","main/AppController","map/WidgetsController"],function(e,t,n,r,i,s,o,u,a){"use strict";var f={init:function(){window.brApp={debugEnabled:!1,debug:function(e){this.debugEnabled&&(typeof e=="string"?console.log(e):console.dir(e))}},this.configureApp(),this.launchApp()},configureApp:function(){brApp.debug("Main.js >>> configureApp"),t.corsEnabledServers.forEach(function(t){e.defaults.io.corsEnabledServers.push(t)})},launchApp:function(){brApp.debug("Main.js >>> launchApp");var e=location.href.split("?")[1],t;e&&(t=i.queryToObject(e)),n.enableLayout(),s.listen(),r.init(),o.init(),u.init();if(t&&t.intro==="no")return;a.showWelcomeDialog()}};return f}),function(){require(["main/Main"],function(e){e.init()})}(),define("js/loader",function(){});